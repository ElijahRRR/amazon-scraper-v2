{% extends "base.html" %}
{% set active_page = "results" %}
{% block title %}采集结果 - Amazon Scraper v2{% endblock %}

{% block content %}
<h2 class="page-title">采集结果</h2>
<p class="page-subtitle">浏览和搜索采集数据</p>

<!-- 统计卡片 -->
<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="stat-card accent">
            <div class="stat-label">总任务</div>
            <div class="stat-number" id="stat-total">{{ progress.total }}</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-card success">
            <div class="stat-label">已完成</div>
            <div class="stat-number" id="stat-done">{{ progress.done }}</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-card warning">
            <div class="stat-label">采集进度</div>
            <div class="stat-number" id="stat-rate">{{ progress.success_rate }}%</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-card danger">
            <div class="stat-label">失败</div>
            <div class="stat-number" id="stat-failed">{{ progress.failed }}</div>
        </div>
    </div>
</div>

<!-- 筛选栏 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label">批次筛选</label>
                <select id="batchFilter" class="form-select">
                    <option value="">全部批次</option>
                    {% for b in batches %}
                    <option value="{{ b.batch_name }}" {% if current_batch == b.batch_name %}selected{% endif %}>
                        {{ b.batch_name }} ({{ b.done }}/{{ b.total }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">搜索</label>
                <input type="text" id="searchInput" class="form-control" placeholder="ASIN 或标题..." value="{{ search }}">
            </div>
            <div class="col-md-2">
                <button class="btn btn-accent w-100" onclick="loadResults(1)"><i class="bi bi-search"></i> 搜索</button>
            </div>
            <div class="col-md-3 text-end">
                <a id="exportExcelBtn" href="#" class="btn btn-outline-accent" style="display:none;">
                    <i class="bi bi-file-earmark-excel"></i> 导出 Excel
                </a>
                <a id="exportCsvBtn" href="#" class="btn btn-outline-accent" style="display:none;">
                    <i class="bi bi-filetype-csv"></i> CSV
                </a>
                <button class="btn btn-outline-danger" onclick="clearDatabase()">
                    <i class="bi bi-trash3"></i> 清空数据库
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 结果列表 -->
<div class="card">
    <div class="card-header d-flex justify-content-between">
        <span><i class="bi bi-table"></i> 共 <span id="resultTotal">{{ total }}</span> 条结果</span>
        <span class="text-secondary">第 <span id="currentPage">{{ current_page }}</span> / <span id="totalPages">{{ total_pages }}</span> 页</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>ASIN</th>
                        <th>标题</th>
                        <th>当前价格</th>
                        <th>BuyBox</th>
                        <th>品牌</th>
                        <th>库存</th>
                        <th>FBA</th>
                        <th>配送</th>
                        <th>采集时间</th>
                        <th>截图</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    {% for r in results %}
                    <tr>
                        <td>
                            <a href="https://www.amazon.com/dp/{{ r.asin }}" target="_blank"
                               class="text-decoration-none" style="color:var(--info)">{{ r.asin }}</a>
                        </td>
                        <td style="max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"
                            title="{{ r.title }}">{{ r.title }}</td>
                        <td>{{ r.current_price or 'N/A' }}</td>
                        <td>{{ r.buybox_price or 'N/A' }}</td>
                        <td>{{ r.brand or 'N/A' }}</td>
                        <td>{{ r.stock_status or 'N/A' }}</td>
                        <td>
                            {% if r.is_fba == 'FBA' %}
                            <span class="badge-status badge-done">FBA</span>
                            {% elif r.is_fba == 'FBM' %}
                            <span class="badge-status badge-pending">FBM</span>
                            {% else %}
                            {{ r.is_fba or 'N/A' }}
                            {% endif %}
                        </td>
                        <td>{{ r.delivery_date or 'N/A' }}</td>
                        <td><small class="text-secondary">{{ r.crawl_time or '' }}</small></td>
                        <td>
                            {% if r.screenshot_path %}
                            <button class="btn btn-sm btn-outline-accent" onclick="showScreenshot(this)" data-path="{{ r.screenshot_path }}" data-asin="{{ r.asin }}" title="查看截图">
                                <i class="bi bi-camera"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not results %}
                    <tr><td colspan="10" class="text-center text-secondary py-4">暂无数据</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 分页 -->
<nav class="mt-3" id="paginationNav">
</nav>

<!-- 截图预览 Modal -->
<div class="modal fade" id="screenshotModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="screenshotModalTitle">截图预览</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-2">
                <img id="screenshotImg" src="" style="max-width:100%; border:1px solid var(--border); border-radius:8px;">
            </div>
            <div class="modal-footer">
                <a id="screenshotDownload" href="#" download class="btn btn-accent">
                    <i class="bi bi-download"></i> 下载截图
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// HTML 转义 — 防止 DOM XSS
function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// 状态管理
let state = {
    batch: '{{ current_batch or "" }}',
    search: '{{ search or "" }}',
    page: {{ current_page }},
    totalPages: {{ total_pages }},
    total: {{ total }}
};

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    updateExportButtons();
    renderPagination();
    loadProgress();

    // 批次切换 → AJAX 刷新
    document.getElementById('batchFilter').addEventListener('change', (e) => {
        state.batch = e.target.value;
        state.page = 1;
        loadResults(1);
        loadProgress();
        updateExportButtons();
    });

    // 搜索框回车
    document.getElementById('searchInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            loadResults(1);
        }
    });
});

// 加载结果（AJAX）
async function loadResults(page) {
    state.page = page;
    state.search = document.getElementById('searchInput').value;

    const params = new URLSearchParams({ page: state.page, per_page: 50 });
    if (state.batch) params.set('batch_name', state.batch);
    if (state.search) params.set('search', state.search);

    try {
        const resp = await fetch(`/api/results?${params}`);
        const data = await resp.json();

        state.total = data.total;
        state.totalPages = data.total_pages;

        document.getElementById('resultTotal').textContent = data.total;
        document.getElementById('currentPage').textContent = data.page;
        document.getElementById('totalPages').textContent = data.total_pages;

        renderResults(data.results);
        renderPagination();
    } catch(e) {
        console.error('加载结果失败:', e);
    }
}

// 渲染结果表格
function renderResults(results) {
    const tbody = document.getElementById('resultsBody');
    if (!results || results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-secondary py-4">暂无数据</td></tr>';
        return;
    }

    tbody.innerHTML = results.map(r => {
        const fbaCell = r.is_fba === 'FBA'
            ? '<span class="badge-status badge-done">FBA</span>'
            : r.is_fba === 'FBM'
                ? '<span class="badge-status badge-pending">FBM</span>'
                : esc(r.is_fba || 'N/A');

        const titleEscaped = esc(r.title || '');
        const asinEscaped = esc(r.asin || '');

        const screenshotCell = r.screenshot_path
            ? `<button class="btn btn-sm btn-outline-accent" onclick="showScreenshot(this)" data-path="${esc(r.screenshot_path)}" data-asin="${asinEscaped}" title="查看截图"><i class="bi bi-camera"></i></button>`
            : '';

        return `<tr>
            <td><a href="https://www.amazon.com/dp/${encodeURIComponent(r.asin)}" target="_blank"
                   class="text-decoration-none" style="color:var(--info)">${asinEscaped}</a></td>
            <td style="max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"
                title="${titleEscaped}">${titleEscaped}</td>
            <td>${esc(r.current_price || 'N/A')}</td>
            <td>${esc(r.buybox_price || 'N/A')}</td>
            <td>${esc(r.brand || 'N/A')}</td>
            <td>${esc(r.stock_status || 'N/A')}</td>
            <td>${fbaCell}</td>
            <td>${esc(r.delivery_date || 'N/A')}</td>
            <td><small class="text-secondary">${esc(r.crawl_time || '')}</small></td>
            <td>${screenshotCell}</td>
        </tr>`;
    }).join('');
}

// 加载进度统计（卡片）
async function loadProgress() {
    try {
        const url = state.batch
            ? `/api/progress/${encodeURIComponent(state.batch)}`
            : '/api/progress';
        const resp = await fetch(url);
        const data = await resp.json();

        document.getElementById('stat-total').textContent = data.total;
        document.getElementById('stat-done').textContent = data.done;
        document.getElementById('stat-rate').textContent = data.success_rate + '%';
        document.getElementById('stat-failed').textContent = data.failed;
    } catch(e) {
        console.error('加载进度失败:', e);
    }
}

// 更新导出按钮
function updateExportButtons() {
    const excelBtn = document.getElementById('exportExcelBtn');
    const csvBtn = document.getElementById('exportCsvBtn');

    if (state.batch) {
        const batchEncoded = encodeURIComponent(state.batch);
        excelBtn.href = `/api/export/${batchEncoded}?format=excel`;
        csvBtn.href = `/api/export/${batchEncoded}?format=csv`;
        excelBtn.style.display = 'inline-block';
        csvBtn.style.display = 'inline-block';
    } else {
        excelBtn.style.display = 'none';
        csvBtn.style.display = 'none';
    }
}

// 渲染分页
function renderPagination() {
    const nav = document.getElementById('paginationNav');
    if (state.totalPages <= 1) {
        nav.innerHTML = '';
        return;
    }

    let pages = [];
    for (let p = 1; p <= state.totalPages; p++) {
        if (p <= 3 || p > state.totalPages - 3 || (p >= state.page - 1 && p <= state.page + 1)) {
            pages.push(p);
        } else if (pages[pages.length - 1] !== '...') {
            pages.push('...');
        }
    }

    const prevDisabled = state.page <= 1 ? 'disabled' : '';
    const nextDisabled = state.page >= state.totalPages ? 'disabled' : '';

    nav.innerHTML = `<ul class="pagination justify-content-center">
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" onclick="event.preventDefault(); loadResults(${state.page - 1})">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        ${pages.map(p => {
            if (p === '...') return '<li class="page-item disabled"><span class="page-link">...</span></li>';
            const active = p === state.page ? 'active' : '';
            return `<li class="page-item ${active}">
                <a class="page-link" href="#" onclick="event.preventDefault(); loadResults(${p})">${p}</a>
            </li>`;
        }).join('')}
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" onclick="event.preventDefault(); loadResults(${state.page + 1})">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    </ul>`;
}

// 清空数据库
async function clearDatabase() {
    if (!confirm('确定要清空数据库中的所有任务和采集结果吗？此操作不可撤销！')) return;
    if (!confirm('再次确认：所有数据将被永久删除，是否继续？')) return;
    try {
        const resp = await fetch('/api/database', { method: 'DELETE' });
        const data = await resp.json();
        alert(`已清空：${data.tasks_deleted} 条任务，${data.results_deleted} 条结果`);
        location.reload();
    } catch(e) {
        alert('清空失败: ' + e.message);
    }
}

// 截图预览
function showScreenshot(btn) {
    const path = btn.dataset.path;
    const asin = btn.dataset.asin;
    document.getElementById('screenshotModalTitle').textContent = `截图预览 - ${asin}`;
    document.getElementById('screenshotImg').src = path;
    document.getElementById('screenshotDownload').href = path;
    new bootstrap.Modal(document.getElementById('screenshotModal')).show();
}
</script>
{% endblock %}
